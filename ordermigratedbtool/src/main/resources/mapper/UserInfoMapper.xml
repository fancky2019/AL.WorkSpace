<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.onlyedu.ordermigratedbtool.dao.UserInfoMapper">
    <update id="updateRelative" parameterType="com.onlyedu.ordermigratedbtool.model.entity.UserInfo">
        UPDATE [dbo].[UserInfo] SET  [EOSUserInfo] = #{eOSUserInfo,jdbcType=VARCHAR} ,[RelativeState] = #{relativeState,jdbcType=BIT}
        WHERE Id=#{id,jdbcType=INTEGER}
    </update>

    <sql id="dynamicWhere">
        <if test="userName != null and userName !='' ">
            and ui.UserName LIKE '%'+#{userName,jdbcType=NVARCHAR}+'%'
        </if>
        <if test="userId != null and userId !='' ">
            and ui.UserId LIKE '%'+#{userId,jdbcType=NVARCHAR}+'%'
        </if>
        <if test="mobilePhone != null">
            and ui.MobilePhone LIKE '%'+#{mobilePhone,jdbcType=NVARCHAR}+'%'
        </if>
        <if test="tel != null">
            and ui.Tel LIKE '%'+#{tel,jdbcType=NVARCHAR}+'%'
        </if>
        <if test="grade != null">
            and ui.Grade = #{grade,jdbcType=VARCHAR}
        </if>
        <if test="relativeState != null">
            and ui.RelativeState = #{relativeState,jdbcType=VARCHAR}
        </if>
        <if test="regTime != null">
            and ui.regTime <![CDATA[ >= ]]> #{regTime,jdbcType=DATE}
        </if>
    </sql>

  <select id="getUserWithOrder" parameterType="com.onlyedu.ordermigratedbtool.model.dto.UserInfoDto" resultType="com.onlyedu.ordermigratedbtool.model.dto.UserInfoDto">
    select * from (
                      select ROW_NUMBER() over(order by (select 0) ) as RowNum,*
                      from
                          (
                              select   ui.Id,  ui.UserId,ui.StudentId,ui.UserName ,ui.Grade ,ui.MobilePhone,ui.Tel,s.School,ui.RegTime,
                              ui.[RelativeState],ui.[EOSUserInfo]
                              from [NewClassesAdmin].[dbo].UserInfo ui
                              left join School s on s.Guid=ui.SchoolId
                              where 1=1
                              and ui.IsDelete=0 and ISNULL(ui.Status,0)=1 and ISNULL(ui.UserType,0)=1 and ISNULL(ui.UserId,'')  <![CDATA[ <> ]]>''
                              and EXISTS (
                              select StudentId from [NewClassesAdmin].[dbo].OrderHead oh
                              where 1=1
                              and oh.IsDelete=0 and oh.OrderType between 1 and 2 and oh.OrderStateId=6
                              and ui.StudentId=oh.StudentId
                              )
                              <include refid="dynamicWhere"></include>
                          ) t1
                  )t2
    where t2.RowNum BETWEEN  (#{pageIndex,jdbcType=INTEGER}-1)*#{pageSize,jdbcType=INTEGER} and #{pageIndex,jdbcType=INTEGER}*#{pageSize,jdbcType=INTEGER}
  </select>

    <select id="getUserWithOrderCount" parameterType="com.onlyedu.ordermigratedbtool.model.dto.UserInfoDto" resultType="java.lang.Integer">
        select count(ui.Id) [count]
        from [NewClassesAdmin].[dbo].UserInfo ui
        left join School s on s.Guid=ui.SchoolId
        where 1=1
        and ui.IsDelete=0 and ISNULL(ui.Status,0)=1 and ISNULL(ui.UserType,0)=1 and ISNULL(ui.UserId,'')  <![CDATA[ <> ]]>''
        and EXISTS (
        select StudentId from [NewClassesAdmin].[dbo].OrderHead oh
        where 1=1
        and oh.IsDelete=0 and oh.OrderType between 1 and 2 and oh.OrderStateId=6
        and ui.StudentId=oh.StudentId
        )<include refid="dynamicWhere"></include>
    </select>


</mapper>